
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventaire — Lecteur robuste (CSV)</title>
<link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
<header>
  <div class="header-inner">
    <h1>Inventaire — Lecteur robuste</h1>
    <div class="controls">
      <select id="domain">
        <option value="faucigny">Faucigny</option>
        <option value="gresivaudan">Grésivaudan</option>
      </select>
      <input id="q" placeholder="Rechercher…"/>
      <select id="year"><option value="">Année…</option></select>
      <button id="btn-fenetres">Fenêtres auto</button>
      <span id="count" class="badge">0</span>
    </div>
  </div>
</header>

<main class="main">
  <div id="diag">
    Domaine: <code id="dname"></code> · Lignes lues: <code id="rows"></code> · En-têtes: <code id="heads"></code>
  </div>
  <table class="table" id="tbl">
    <thead>
      <tr><th>Date</th><th>N°</th><th>Personnages / Objet</th><th>Latin</th><th>Traduction</th><th></th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p><small class="muted">Si “Faucigny” affiche 0, vérifie que <code>assets/faucigny.csv</code> contient bien les colonnes attendues.</small></p>
</main>

<div class="modal" id="modal">
  <div class="card">
    <header>
      <div><strong id="m-title"></strong><div id="m-meta" style="color:#a8acb3;font-size:12px"></div></div>
      <div>
        <button id="prev">◀</button>
        <button id="play">Lecture auto</button>
        <button id="next">▶</button>
        <button id="close">Fermer ✕</button>
      </div>
    </header>
    <div class="section">
      <h3>Personnages / Objet</h3>
      <div id="m-objet"></div>
    </div>
    <div class="section">
      <h3>Texte latin</h3>
      <pre id="m-latin"></pre>
    </div>
    <div class="section">
      <h3>Traduction</h3>
      <div id="m-trad"></div>
    </div>
  </div>
</div>

<script>
// Robust CSV loader with BOM strip and header normalization
function stripBOM(s){ if(s.charCodeAt(0)===0xFEFF){ return s.slice(1);} return s; }
async function loadCSV(url){
  const resp = await fetch(url);
  const raw = await resp.text();
  const txt = stripBOM(raw);
  const lines = txt.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(!lines.length) return {headers:[], rows:[]};
  // detect delimiter on header line
  const headLine = lines[0];
  const comma = (headLine.match(/,/g)||[]).length;
  const semi = (headLine.match(/;/g)||[]).length;
  const delim = semi>comma ? ';' : ',';
  const headers = headLine.split(delim).map(h=>h.trim());
  function parseLine(line){
    const cells=[]; let cur=''; let inq=false;
    for(let j=0;j<line.length;j++){
      const ch=line[j];
      if(ch==='"'){inq=!inq; continue;}
      if(ch===delim && !inq){cells.push(cur); cur='';} else {cur+=ch;}
    }
    cells.push(cur);
    return cells.map(c=>c.trim());
  }
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cells = parseLine(lines[i]);
    const obj={};
    headers.forEach((h,idx)=> obj[h] = (cells[idx]||"").trim());
    rows.push(obj);
  }
  return {headers, rows};
}
function normKey(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').replace(/é/g,'e').replace(/è/g,'e').replace(/ê/g,'e').replace(/°/g,''); }
const F = {
  date: ['date'],
  num: ['n acte','n','no acte','numero','n° acte','n°'],
  objet: ['personnages / objet','personnages','objet'],
  latin: ['citation latine','latin'],
  trad: ['traduction francaise','traduction française','traduction']
};
function getField(row, want, headers){
  // find first matching header in row
  for(const h of headers){
    const nk = normKey(h);
    for(const cand of F[want]){
      if(nk === cand) return row[h] || '';
    }
  }
  return '';
}
function yearFrom(s){ const m=(s||'').match(/(\d{4})/); return m?m[1]:''; }

const S={rows:[],filtered:[],idx:0,playing:false,timer:null,interval:6000,domain:'faucigny',headers:[]};

function yearOptions(){
  const sel=document.getElementById('year'); sel.innerHTML='<option value="">Année…</option>';
  const years=[...new Set(S.rows.map(r=>yearFrom(getField(r,'date',S.headers))))].filter(Boolean).sort();
  years.forEach(y=>{const o=document.createElement('option'); o.value=y; o.textContent=y; sel.appendChild(o);});
}
function applyFilter(){
  const q=(document.getElementById('q').value||'').toLowerCase();
  const y=document.getElementById('year').value;
  S.filtered = S.rows.filter(r=>{
    const date = getField(r,'date',S.headers);
    const num = getField(r,'num',S.headers);
    const obj = getField(r,'objet',S.headers);
    const lat = getField(r,'latin',S.headers);
    const trd = getField(r,'trad',S.headers);
    const blob = [date,num,obj,lat,trd].join(' ').toLowerCase();
    const okQ = !q || blob.includes(q);
    const okY = !y || yearFrom(date)===y;
    return okQ && okY;
  });
  document.getElementById('count').textContent = S.filtered.length;
  document.getElementById('rows').textContent = S.rows.length;
  document.getElementById('heads').textContent = S.headers.join(' | ');
  renderTable();
}
function renderTable(){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  S.filtered.forEach((r,i)=>{
    const date = getField(r,'date',S.headers);
    const num = getField(r,'num',S.headers);
    const obj = getField(r,'objet',S.headers);
    const lat = getField(r,'latin',S.headers);
    const trd = getField(r,'trad',S.headers);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${date}</td>
                    <td>${num}</td>
                    <td>${obj}</td>
                    <td>${lat.slice(0,140)}${lat.length>140?'…':''}</td>
                    <td>${trd.slice(0,140)}${trd.length>140?'…':''}</td>
                    <td><button data-i="${i}">Voir</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=> b.addEventListener('click', e=> openModal(parseInt(e.target.getAttribute('data-i'),10))));
}
function openModal(i){
  S.idx=i;
  const r=S.filtered[i];
  const date = getField(r,'date',S.headers);
  const num = getField(r,'num',S.headers);
  const obj = getField(r,'objet',S.headers);
  const lat = getField(r,'latin',S.headers);
  const trd = getField(r,'trad',S.headers);
  document.getElementById('m-title').textContent = `Acte ${num}`;
  document.getElementById('m-meta').textContent = date;
  document.getElementById('m-objet').textContent = obj;
  document.getElementById('m-latin').textContent = lat;
  document.getElementById('m-trad').textContent = trd;
  document.getElementById('modal').classList.add('open');
}
function closeModal(){document.getElementById('modal').classList.remove('open'); stop();}
function next(d=1){if(!S.filtered.length)return; S.idx=(S.idx+d+S.filtered.length)%S.filtered.length; openModal(S.idx);}
function play(){S.playing=true;document.getElementById('play').textContent='Lecture auto (ON)'; if(S.timer)clearInterval(S.timer); S.timer=setInterval(()=>next(1),S.interval);}
function stop(){S.playing=false;document.getElementById('play').textContent='Lecture auto'; if(S.timer){clearInterval(S.timer);S.timer=null;}}

document.getElementById('btn-fenetres').onclick=()=>{ if(S.filtered.length){ openModal(0); play(); } };
document.getElementById('close').onclick=closeModal;
document.getElementById('next').onclick=()=>next(1);
document.getElementById('prev').onclick=()=>next(-1);
document.getElementById('play').onclick=()=> S.playing ? stop() : play();
document.getElementById('q').oninput=applyFilter;
document.getElementById('year').onchange=applyFilter;
document.getElementById('domain').onchange=async(e)=>{
  const d=e.target.value; S.domain=d;
  document.getElementById('dname').textContent = d;
  const {headers, rows} = await loadCSV('assets/'+d+'.csv');
  S.headers = headers;
  S.rows = rows;
  yearOptions(); applyFilter();
};

(async function init(){
  document.getElementById('dname').textContent = 'faucigny';
  const {headers, rows} = await loadCSV('assets/faucigny.csv');
  S.headers = headers;
  S.rows = rows;
  yearOptions(); applyFilter();
})();
</script>
</body>
</html>
