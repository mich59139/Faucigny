
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventaire — DIAGNOSTIC</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:2rem;line-height:1.5}
pre{background:#f5f7fb;border:1px solid #dfe3f1;padding:10px;border-radius:8px;white-space:pre-wrap}
.ok{color:#167d2f;font-weight:600}
.err{color:#b00020;font-weight:600}
.card{border:1px solid #e2e6f3;border-radius:12px;padding:16px;margin:12px 0;background:#fff}
small{color:#63708a}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #e2e6f3;padding:6px;text-align:left;font-size:14px}
h1{margin:0 0 8px}
</style>
</head>
<body>
<h1>Inventaire — Page de DIAGNOSTIC</h1>
<p>Cette page vérifie la <strong>présence</strong> et le <strong>format</strong> des CSV, puis affiche un aperçu. Elle aide à comprendre pourquoi la page de lecture reste vide.</p>

<div class="card">
  <h3>1) Emplacements attendus (relatifs)</h3>
  <ul>
    <li><code>assets/faucigny.csv</code></li>
    <li><code>assets/gresivaudan.csv</code></li>
  </ul>
  <small>Si l’un revient en 404, il n’a pas été téléversé au bon endroit.</small>
</div>

<div class="card">
  <h3>2) Test de chargement</h3>
  <button id="run">Lancer les tests</button>
  <div id="out"></div>
</div>

<div class="card">
  <h3>3) Aperçu des premières lignes (si OK)</h3>
  <h4>Faucigny</h4>
  <div id="prev-f"></div>
  <h4>Grésivaudan</h4>
  <div id="prev-g"></div>
</div>

<div class="card">
  <h3>4) Lecteur minimal</h3>
  <p>Si les CSV se chargent, cette table doit lister des lignes immédiatement.</p>
  <label>Domaine:</label>
  <select id="domain">
    <option value="faucigny">Faucigny</option>
    <option value="gresivaudan">Grésivaudan</option>
  </select>
  <input id="q" placeholder="rechercher…"/>
  <table>
    <thead><tr><th>Date</th><th>N° acte</th><th>Personnages / Objet</th><th>Latin (début)</th><th>Traduction (début)</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
function stripBOM(s){ if(s.charCodeAt(0)===0xFEFF){ return s.slice(1);} return s; }
async function fetchText(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(res.status+" "+res.statusText);
  return await res.text();
}
function detectDelim(head){
  const c=(head.match(/,/g)||[]).length;
  const s=(head.match(/;/g)||[]).length;
  return s>c?';':',';
}
function parseCSV(txt){
  txt = stripBOM(txt);
  const lines = txt.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(!lines.length) return {headers:[],rows:[]};
  const delim = detectDelim(lines[0]);
  const headers = lines[0].split(delim).map(h=>h.trim());
  function parseLine(line){
    const cells=[]; let cur=''; let inq=false;
    for(let j=0;j<line.length;j++){
      const ch=line[j];
      if(ch==='"'){inq=!inq; continue;}
      if(ch===delim && !inq){cells.push(cur); cur='';} else {cur+=ch;}
    }
    cells.push(cur);
    return cells.map(c=>c.trim());
  }
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cells=parseLine(lines[i]);
    const o={}; headers.forEach((h,idx)=>o[h]=cells[idx]||''); rows.push(o);
  }
  return {headers, rows, delim};
}
function normKey(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').replace(/é/g,'e').replace(/è/g,'e').replace(/ê/g,'e').replace(/°/g,''); }
const MAP = {
  date:['date'],
  num:['n acte','n','no acte','numero','n° acte','n°'],
  objet:['personnages / objet','personnages','objet'],
  latin:['citation latine','latin'],
  trad:['traduction francaise','traduction française','traduction']
};
function pick(row, headers, key){
  for(const h of headers){
    const nk = normKey(h);
    for(const cand of MAP[key]){
      if(nk===cand) return row[h]||'';
    }
  }
  return '';
}

async function testOne(name){
  const out = document.getElementById('out');
  out.innerHTML += `<p>• Lecture de <code>assets/${name}.csv</code>…</p>`;
  try{
    const txt = await fetchText('assets/'+name+'.csv');
    out.innerHTML += `<p class="ok">✓ Chargé</p>`;
    const parsed = parseCSV(txt);
    out.innerHTML += `<p>En-têtes détectés: <code>${parsed.headers.join(' | ')}</code></p>`;
    out.innerHTML += `<p>Nombre de lignes: <code>${parsed.rows.length}</code></p>`;
    return parsed;
  }catch(e){
    out.innerHTML += `<p class="err">✗ Erreur: ${e.message}</p>`;
    return {headers:[],rows:[]};
  }
}

function preview(divId, parsed){
  const div = document.getElementById(divId);
  if(!parsed.rows.length){ div.innerHTML = '<em>Aucune ligne</em>'; return; }
  const n = Math.min(3, parsed.rows.length);
  let html = '<table><thead><tr>';
  html += '<th>Date</th><th>N°</th><th>Objet</th><th>Latin (début)</th><th>Trad (début)</th>';
  html += '</tr></thead><tbody>';
  for(let i=0;i<n;i++){
    const r = parsed.rows[i];
    const date = pick(r, parsed.headers, 'date');
    const num = pick(r, parsed.headers, 'num');
    const obj = pick(r, parsed.headers, 'objet');
    const lat = pick(r, parsed.headers, 'latin');
    const trd = pick(r, parsed.headers, 'trad');
    html += `<tr><td>${date}</td><td>${num}</td><td>${obj}</td><td>${(lat||'').slice(0,80)}</td><td>${(trd||'').slice(0,80)}</td></tr>`;
  }
  html += '</tbody></table>';
  div.innerHTML = html;
}

let DATA = {};
document.getElementById('run').addEventListener('click', async ()=>{
  const pf = await testOne('faucigny');
  preview('prev-f', pf);
  DATA.faucigny = pf;

  const pg = await testOne('gresivaudan');
  preview('prev-g', pg);
  DATA.gresivaudan = pg;

  document.getElementById('domain').dispatchEvent(new Event('change'));
});

document.getElementById('domain').addEventListener('change', (e)=>{
  const d = e.target.value;
  const parsed = DATA[d];
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  if(!parsed || !parsed.rows.length){ tb.innerHTML = '<tr><td colspan="5"><em>Pas de données</em></td></tr>'; return; }
  const rows = parsed.rows;
  const headers = parsed.headers;
  const q = (document.getElementById('q').value||'').toLowerCase();
  let count = 0;
  for(const r of rows){
    const date = pick(r, headers, 'date');
    const num = pick(r, headers, 'num');
    const obj = pick(r, headers, 'objet');
    const latin = pick(r, headers, 'latin');
    const trad = pick(r, headers, 'trad');
    const blob = [date,num,obj,latin,trad].join(' ').toLowerCase();
    if(q && !blob.includes(q)) continue;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${date}</td><td>${num}</td><td>${obj}</td><td>${(latin||'').slice(0,120)}</td><td>${(trad||'').slice(0,120)}</td>`;
    tb.appendChild(tr);
    count++;
    if(count>200) break; // limiter l'aperçu
  }
  if(count===0){ tb.innerHTML = '<tr><td colspan="5"><em>Aucune ligne avec ce filtre</em></td></tr>'; }
});
document.getElementById('q').addEventListener('input', ()=>{
  document.getElementById('domain').dispatchEvent(new Event('change'));
});
</script>
</body>
</html>
